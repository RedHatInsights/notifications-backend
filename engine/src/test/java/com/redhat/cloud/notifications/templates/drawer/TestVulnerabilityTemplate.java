package com.redhat.cloud.notifications.templates.drawer;

import com.redhat.cloud.notifications.IntegrationTemplatesInDbHelper;
import com.redhat.cloud.notifications.TestHelpers;
import com.redhat.cloud.notifications.ingress.Action;
import io.quarkus.test.junit.QuarkusTest;
import org.junit.jupiter.api.Test;
import java.util.List;

import static org.junit.jupiter.api.Assertions.assertEquals;

@QuarkusTest
class TestVulnerabilityTemplate extends IntegrationTemplatesInDbHelper {

    private static final Action ACTION = TestHelpers.createVulnerabilityAction();

    static final String NEW_CVE_HIGH_CVSS_EVENT = "new-cve-cvss";
    static final String NEW_CVE_CRIT_SEVERITY_EVENT = "new-cve-severity";
    static final String NEW_CVE_SECURITY_RULE_EVENT = "new-cve-security-rule";
    static final String ANY_CVE_KNOWN_EXPLOIT_EVENT = "any-cve-known-exploit";

    @Override
    protected String getApp() {
        return "vulnerability";
    }

    @Override
    protected List<String> getUsedEventTypeNames() {
        return List.of(NEW_CVE_HIGH_CVSS_EVENT, NEW_CVE_CRIT_SEVERITY_EVENT, NEW_CVE_SECURITY_RULE_EVENT, ANY_CVE_KNOWN_EXPLOIT_EVENT);
    }

    @Test
    void testRenderedTemplateNewCveHighCvss() {
        String result = generateDrawerTemplate(NEW_CVE_HIGH_CVSS_EVENT, ACTION);
        assertEquals("Red Hat Insights has just identified a CVE with a CVSS score of >= 7. Please review the details of this CVE and affected systems to determine risk and exposure for your organization.", result);
    }

    @Test
    void testRenderedTemplateNewCveCritSeverity() {
        String result = generateDrawerTemplate(NEW_CVE_CRIT_SEVERITY_EVENT, ACTION);
        assertEquals("Red Hat Insights has just identified a CVE with a severity of Critical. Please review the details of this CVE and affected systems to determine risk and exposure for your organization.", result);
    }

    @Test
    void testRenderedTemplateNewCveSecurityRule() {
        String result = generateDrawerTemplate(NEW_CVE_SECURITY_RULE_EVENT, ACTION);
        assertEquals("Red Hat Insights has just identified a newly published CVE with the Security rule label. Please review the details of this CVE and affected systems to determine risk and exposure for your organization. Red Hat recommends treating this issue with high priority to protect your organization.", result);
    }

    @Test
    void testRenderedTemplateAnyKnownExploit() {
        String result = generateDrawerTemplate(ANY_CVE_KNOWN_EXPLOIT_EVENT, ACTION);
        assertEquals("Red Hat Insights has just identified a CVE with the Known Exploit label. Please review the details of this **CVE-TEST**. The \"Known Exploit\" flag is added to any CVE that is determined to have been exploited in the \"wild\" by Red Hat Product Security. This flag does not reflect your environment.", result);
    }
}
