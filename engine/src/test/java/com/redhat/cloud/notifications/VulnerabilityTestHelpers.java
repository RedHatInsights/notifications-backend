package com.redhat.cloud.notifications;

import com.redhat.cloud.notifications.ingress.Action;
import com.redhat.cloud.notifications.ingress.Event;
import com.redhat.cloud.notifications.ingress.Metadata;
import com.redhat.cloud.notifications.ingress.Payload;
import com.redhat.cloud.notifications.models.EmailAggregation;
import com.redhat.cloud.notifications.processors.email.aggregators.VulnerabilityEmailPayloadAggregator;
import com.redhat.cloud.notifications.transformers.BaseTransformer;
import io.vertx.core.json.JsonObject;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Map;

import static com.redhat.cloud.notifications.TestConstants.DEFAULT_ORG_ID;

public class VulnerabilityTestHelpers {

    public static BaseTransformer baseTransformer = new BaseTransformer();

    public static EmailAggregation createEmailAggregation(String bundle, String application, String eventType, String cve) {
        EmailAggregation aggregation = new EmailAggregation();
        aggregation.setOrgId(DEFAULT_ORG_ID);
        aggregation.setBundleName(bundle);
        aggregation.setApplicationName(application);

        Action emailActionMessage = new Action();
        emailActionMessage.setOrgId(DEFAULT_ORG_ID);
        emailActionMessage.setApplication(application);
        emailActionMessage.setBundle(bundle);
        emailActionMessage.setTimestamp(LocalDateTime.now());
        emailActionMessage.setEventType(eventType);
        emailActionMessage.setEvents(List.of(
            new Event.EventBuilder().withMetadata(new Metadata.MetadataBuilder()
                                                              .build())
                                    .withPayload(new Payload.PayloadBuilder()
                                                            .withAdditionalProperty("reported_cve", cve)
                                                            .build())
                                    .build()
        ));
        JsonObject payload = baseTransformer.toJsonObject(emailActionMessage);
        aggregation.setPayload(payload);

        return aggregation;
    }

    public static List<String> getReportedCves(VulnerabilityEmailPayloadAggregator aggregator) {
        Map<String, Map> vuln = (Map<String, Map>) aggregator.getContext().get("vulnerability");
        return (List<String>) vuln.get("reported_cves");
    }
}
