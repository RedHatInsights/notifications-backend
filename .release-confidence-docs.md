# Release documentation

This documentation enables AI systems to perform enhanced release risk analysis by providing essential context about the Notifications service that cannot be determined from code changes alone.

## Service overview

### Service criticality

Major - Core notification infrastructure for the Red Hat [Hybrid Cloud Console](https://console.redhat.com).

### Description

Platform service delivering notifications from multiple Red Hat services via email and to Google Chat, Microsoft Teams, PagerDuty, ServiceNow, Slack, Splunk and webhooks.

### Traffic

Multi-tenant SaaS serving Red Hat customers and internal services with varying load patterns.

### Business impact

Email notifications have major business impact as the primary notification channel. Other channels have a lesser, yet significant impact.
Notification delivery failures affect customer engagement, compliance alerting, and critical system alerts across Red Hat's cloud services portfolio.

## System architecture

### Components overview

The Notifications service is composed of 14 microservices deployed as ClowdApps in OpenShift.

#### Notifications-aggregator

- Description: Short-lived Java app run from an OpenShift cronjob to trigger the email aggregation process.
- Outage impact: moderate - aggregated email might be delayed.
- Dependencies: `notifications-backend`.

#### Notifications-backend

- Description: Public REST API service used by Notifications frontend and other Red Hat services - API must not be broken. Users are authenticated via RBAC. Handles Notifications settings, Integrations settings and user preferences.
- Outage impact: high - Notifications REST API and UI are unavailable.
- Dependencies: `notifications-engine`, `rbac`.

#### Notifications-connector-drawer

- Description: Connector responsible for the delivery of notifications to the internal Drawer component from the Hybrid Cloud Console.
- Outage impact: low - not enabled in production yet.
- Dependencies: `notifications-recipients-resolver`.

#### Notifications-connector-email

- Description: Connector responsible for the delivery of notifications via email.
- Outage impact: high - emails might be delayed or require a replay depending on the outage cause.
- Dependencies: `backoffice-proxy`, `notifications-engine`, `notifications-recipients-resolver`.

#### Notifications-connector-google-chat

- Description: Connector responsible for the delivery of notifications to Google Chat.
- Outage impact: moderate - notifications might be delayed or require a replay depending on the outage cause.
- Dependencies: none.

#### Notifications-connector-microsoft-teams

- Description: Connector responsible for the delivery of notifications to Microsoft Teams.
- Outage impact: moderate - notifications might be delayed or require a replay depending on the outage cause.
- Dependencies: none.

#### Notifications-connector-pagerduty

- Description: Connector responsible for the delivery of notifications to PagerDuty.
- Outage impact: moderate - notifications might be delayed or require a replay depending on the outage cause.
- Dependencies: `sources-api`.

#### Notifications-connector-servicenow

- Description: Connector responsible for the delivery of notifications to ServiceNow.
- Outage impact: moderate - notifications might be delayed or require a replay depending on the outage cause.
- Dependencies: `sources-api`.

#### Notifications-connector-slack

- Description: Connector responsible for the delivery of notifications to Slack.
- Outage impact: moderate - notifications might be delayed or require a replay depending on the outage cause.
- Dependencies: none.

#### Notifications-connector-splunk

- Description: Connector responsible for the delivery of notifications to Splunk.
- Outage impact: moderate - notifications might be delayed or require a replay depending on the outage cause.
- Dependencies: `sources-api`.

#### Notifications-connector-webhook

- Description: Connector responsible for the delivery of notifications to webhooks.
- Outage impact: moderate - notifications might be delayed or require a replay depending on the outage cause.
- Dependencies: `sources-api`.

#### Notifications-engine

- Description: Processes incoming Kafka events from `platform.notifications.ingress` topic (primary entry from multiple Red Hat services) and forwards notification instructions to connectors.
- Outage impact: critical - all notification channels might be interrupted.
- Dependencies: `ingress`, `notifications-backend`, `notifications-recipients-resolver`.

#### Notifications-gw

- Description: Secondary entry point from [separate repo](https://github.com/RedHatInsights/notifications-gw) deployed in same OpenShift namespace - internal gateway accepting events via REST API.
- Outage impact: high - other Red Hat services are unable to produce Notifications events.
- Dependencies: `notifications-backend`.

#### Notifications-recipients-resolver

- Description: Determines notification recipients using external services which vary depending on the environments. Depends on TLS certificate requiring regular renewal - renewal failures will cause outages.
- Outage impact: high - notifications via email or to the Drawer will fail and likely require a replay.
- Dependencies: `it-user-service`, `mbop`, `rbac`.

### Data flow overview

**Primary Event Flow:**
Red Hat services â†’ platform.notifications.ingress Kafka topic â†’ Notifications Engine â†’ Connectors â†’ External delivery

**Secondary Event Flow:**
Red Hat services â†’ Notifications Gateway REST API â†’ platform.notifications.ingress Kafka topic â†’ Notifications Engine â†’ Connectors â†’ External delivery

### Technology stack

#### Runtime

- Java 21.
- Quarkus framework - upgrades require special care due to historical outages.

#### Database

- PostgreSQL.
- Migrations are performed with Flyway Community Edition (no `undo` capacity) - rollbacks can only be done with roll-forward migrations.

#### Deployment

- Each component is a ClowdApp and gets its configuration from Clowder.
- Components are deployed in OpenShift.

#### Monitoring

- Metrics are collected in Prometheus.
- Warnings and errors are pushed to Sentry.
- Logs are pushed to CloudWatch.

#### Feature management

- Feature toggles are managed from Unleash - critical to prevent outages.

#### Message queue

- Kafka-based processing with critical `platform.notifications.ingress` topic - lag can compromise entire service.

## Release risk assessment

### ðŸ”´ Immediate deployment blockers

**1. Database schema changes**
- Flyway Community Edition (no `undo`) executed at backend startup.
- Large events table with 15-day retention and active cleanup jobs.
- **Mitigation:** Test with production data volumes, prepare roll-forward scripts.

**2. External API contract changes**
- Breaking changes affect frontend and multiple Red Hat services.
- Multi-versioned API support (v1.0, v2.0) must maintain backward compatibility.
- **Mitigation:** Extensive client coordination, version compatibility testing.

**3. Index additions on large tables**
- Adding indexes to large tables (e.g., `events` table with 15-day retention) can cause migrations to run longer than health check timeouts.
- If OpenShift kills the `notifications-backend` pod before migration completes, the migration fails in an incomplete state.
- **Risk indicators:** SQL migrations containing `CREATE INDEX` on high-volume tables.
- **Mitigation:**
  - Increase `failureThreshold` for liveness/readiness probes in ClowdApp configuration before deploying.
  - Consider using `CREATE INDEX CONCURRENTLY` when possible (note: cannot run inside a transaction).
  - Test migration duration against production-like data volumes.

**4. New DB fields consumed by non-backend pods in same release**
- Only `notifications-backend` runs Flyway migrations at startup; other pods (e.g., `notifications-engine`) do not.
- If a release introduces a new DB field AND code in non-backend pods that consumes that field, those pods may start and process messages before the migration completes.
- This causes failures when pods try to access columns that don't exist yet.
- **Risk indicators:**
  - SQL migration adding new columns (`ALTER TABLE ... ADD COLUMN`)
  - Code changes in non-backend modules (e.g., `engine/`, `connector-*/`) referencing those new columns
- **Mitigation:** Split into two releases:
  1. **Release 1:** Add the DB field only (migration runs, no code consumes the new field)
  2. **Release 2:** Add code that consumes the new field (field is guaranteed to exist)
- **Critical:** This is an immediate deployment blocker if both changes are detected in the same release.

### ðŸŸ¡ High-risk patterns requiring scrutiny

**Known outage patterns:**
1. **TLS certificate expiration** (`notifications-recipients-resolver`)
2. **Quarkus framework upgrades** 
3. **Database migration issues**

**High-risk file patterns:**
- `database/src/main/resources/db/migration/V*.sql` - Schema changes
- `backend/src/main/java/com/redhat/cloud/notifications/routers/` - Public API endpoints
- `.rhcicd/clowdapp-*.yaml` - Deployment configurations
- `pom.xml` with Quarkus version updates
- `application.properties` with database/external service configs
- Files containing `auth`, `rbac`, `security` paths

**Performance-critical areas:**
- Event processing pipeline (Kafka lag monitoring critical)
- Database queries on large events table 
- Multi-tenant data isolation (org_id filtering)

### ðŸŸ¢ Risk mitigators
- **Unleash feature toggles:** Critical for outage prevention - all new features should be gated.
- **Event replay capability:** 15-day database storage enables recovery from outages.
- **Comprehensive testing:** JUnit 5, Quarkus Test, TestContainers, REST Assured, IQE

## AI analysis guidelines

### Change analysis framework

**Low-Risk Patterns:**
- Test files: `*Test.java`, `*ITest.java`
- Documentation: `README.adoc`, `docs/`, `helpers/`
- Patch updates: Minor version bumps in `pom.xml` (excluding Quarkus)

**High-Risk Patterns:**
- Database: `V*.sql` migration files
- APIs: `backend/src/main/java/com/redhat/cloud/notifications/routers/`
- Config: `.rhcicd/clowdapp-*.yaml`, `application.properties`
- Security: Files with `auth`, `rbac`, `security` paths
- Framework: Quarkus version updates

### Risk Scoring Factors

**Automatic High Risk:**
- Database schema migrations (Flyway Community Edition limitations)
  - **Index on large tables:** `CREATE INDEX` on `events` or other high-volume tables requires extended health check timeouts or thresholds
  - **New field + cross-pod consumption:** New columns consumed by non-backend pods in the same release is a **critical blocker** â€” must be split into two releases
- Public API changes (affects frontend + multiple Red Hat services)
- Authentication/authorization modifications (RBAC and Kessel)
- Quarkus framework upgrades (historical outage source)
  - **Action required:** Review [Quarkus Migration Guides](https://github.com/quarkusio/quarkus/wiki/Migration-Guides) for all version changes before releasing
- Recipients-resolver changes (TLS certificate dependency)

**Risk Amplifiers:**
- Multiple service modifications simultaneously  
- Configuration changes affecting ClowdApps
- External dependency modifications (RBAC, Sources, Kessel)
- Changes without Unleash feature toggle protection

**Risk Mitigators:**
- Comprehensive test coverage (JUnit, TestContainers, integration)
- Feature toggle gating via Unleash
- Small, focused changes (<10 files)
- Staging environment validation
- Roll-forward database migration scripts prepared

## Additional Documentation

- https://gitlab.cee.redhat.com/core-platform-apps/notifications-docs/-/blob/master/docs/architecture/index.md
